<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--<script>location.href="localhost:8080/dashboard";</script>-->
    <title>Dashboard de Aluguel de Bicicleta</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
        }

        .dashboard-container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #333;
        }

        .status-info {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
        }

        .status-card {
            flex: 1;
            background-color: #eaeaea;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin: 0 10px;
        }

        .status-card h2 {
            color: #666;
        }

        .status-card p {
            font-size: 1.5rem;
            color: #333;
        }

        .gps-info {
            margin-top: 20px;
            background-color: #e0f7fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .gps-info h3 {
            color: #00796b;
        }

        .gps-info p {
            color: #004d40;
            font-size: 1.2rem;
        }

        .not-alugado {
            text-align: center;
            font-size: 1.2rem;
            color: #d32f2f;
        }
    </style>

    <script>
        window.onload = function () {
            // Obtém o valor do código da sessão
            const codigoPessoa = '[[${ session.codigoPessoa }]]'; // Use a sintaxe correta do Thymeleaf para obter o valor
            const codigoBicicleta = '[[${ session.codigoBicicleta }]]';
            const codigoAluguel = '[[${ session.codigoAluguel }]]';
            const codigoCarteira = '[[${ session.codigoCarteira }]]';

            console.log("Pessoa: " + '[[${ session.codigoPessoa }]]');
            console.log("Bicicleta: " + '[[${ session.codigoBicicleta }]]');
            console.log("Aluguel: " + '[[${ session.codigoAluguel }]]');
            console.log("Carteira: " + '[[${ session.codigoCarteira }]]');
            // Verifica se o código é maior que 0 ou não nulo
            if (codigoPessoa == null || codigoPessoa == "null") {
                // Redireciona para a página de dashboard
                window.location.href = 'http://localhost:8081/'; // Altere o caminho conforme necessário
            }

            if (codigoBicicleta == null || codigoBicicleta < 1) {
                document.getElementById("statusBicicleta").style.display = "none";
				document.getElementById("semBicicleta").style.visibility = "visible";
                console.log("Sem Bike");
				
            } else {
                console.log("Com Bike");
                document.getElementById("statusBicicleta").style.visibility = "visible";
				document.getElementById("semBicicleta").style.display = "none";
            }

        }
    </script>
	
	
	
	

	
	
</head>

<body>
    <div class="dashboard-container">
        <h1>Dashboard de Aluguel de Bicicleta</h1>

        <div class="gps-info">
            <h3>Olá, <span th:text="${session.nome} ">, aproveite nossos serviços</h3>
            <p>...status...atualizações...financeiro...</p>
        </div>


		<div class="gps-info">
			<h2>Status Aluguel</h2>
        	<div class="status-info" id="statusBicicleta">
        	    <div class="status-card">
        	        <h2>Bicicleta: <span th:text="${session.codigoBicicleta}">?</span></h2>
					<span id="bibicleta-obs">?</span>
					<h3><span th:text="${session.descricaoBicicleta}">?</span></h3>
				
        	        <p th:text="${session.statusBicicleta}">Alugado</p>
        	    </div>
        	    
				
				<div class="status-card">
					<h2>Tempo de Uso</h2>
					<p id="tempo-uso">Calculando...</p>
				</div>

				<div class="status-card">
				    <h2>Valor a Pagar</h2>
					<h3 id="valor-obs">...</h3>
				    <p id="valor-pagar">Calculando...</p>
				</div>
					
        	</div>
		</div>


		<!--
        <div class="gps-info">
            <h3>Localização Atual do Patinete</h3>
            <p id="gps-local">Rua Exemplo, 123 - Centro, Cidade</p>
        </div>-->

        <!-- Se o usuário não estiver com patinete alugado -->

        <div class="not-alugado" id="semBicicleta">
            <p>Você não está com nenhuma Bicicleta, Deseja alugar?</p>
        </div>


        
    </div>

    <script>
        // Exemplo de simulação de dados dinâmicos
        const tempoUso = document.getElementById("tempo-uso");
        const gpsLocal = document.getElementById("gps-local");

        // Atualizando os dados (poderia ser via AJAX, fetch etc.)
        tempoUso.innerText = "25 min";
        gpsLocal.innerText = "Av. Principal, 200 - Bairro, Cidade";



    </script>
	
	
	
	<script>
		// Obter dados do Thymeleaf
		    const retirada = /*[[${session.datahoraRetirada}]]*/ '2024-11-22T08:00:00'; // Exemplo de data
		    const devolvida = /*[[${session.datahoraDevolvida}]]*/ null; // Exemplo: null se ainda não devolvido
		    const precoPorHora = /*[[${session.precobicicleta}]]*/ 2; // Exemplo: custo por hora em reais

			document.getElementById('bibicleta-obs').innerText = `Preço por hora R$ ${precoPorHora.toFixed(2)}`;
			//bibicleta-obs
		    // Função para formatar a duração
		    function formatDuration(ms) {
		        const totalMinutes = Math.floor(ms / 60000);
		        const days = Math.floor(totalMinutes / 1440); // 1440 minutos em um dia
		        const hours = Math.floor((totalMinutes % 1440) / 60); // Horas restantes
		        const minutes = totalMinutes % 60; // Minutos restantes

		        if (days > 0) {
		            return `${days}d ${hours} h ${minutes} min`;
		        } else if (hours > 0) {
		            return `${hours} h ${minutes} min`;
		        } else {
		            return `${minutes} min`;
		        }
		    }

		    // Função para calcular o tempo de uso
		    function calculateUsage() {
		        const retiradaTime = new Date(retirada);
		        const endTime = devolvida ? new Date(devolvida) : new Date();

		        // Validar se as datas são válidas
		        if (isNaN(retiradaTime) || isNaN(endTime)) {
		            document.getElementById('tempo-uso').innerText = 'Erro: Data inválida';
		            document.getElementById('valor-pagar').innerText = 'Erro: Data inválida';
		            return;
		        }

		        const duration = endTime - retiradaTime;

		        // Verificar se a duração é negativa
		        if (duration < 0) {
		            document.getElementById('tempo-uso').innerText = 'Erro: Horário inválido';
		            document.getElementById('valor-pagar').innerText = 'Erro: Horário inválido';
		            return;
		        }

		        // Atualizar o tempo formatado
		        document.getElementById('tempo-uso').innerText = formatDuration(duration);

		        // Calcular e exibir o valor a pagar
		        calculatePayment(duration);
		    }

		    // Função para calcular o valor a pagar com base em horas e minutos fracionados
		    function calculatePayment(ms) {
		        // Convertendo milissegundos para horas fracionadas
		        const totalHours = ms / 3600000; // Total de horas com fração (1 hora = 3600000 ms)
		        
		        // Calcular o valor baseado nas horas fracionadas
		        const valor = totalHours * precoPorHora;

		        // Atualizar o elemento com o valor formatado
				if(devolvida == null){
					document.getElementById('valor-obs').innerText = ` Valor aproximado`;
				}else{
					document.getElementById('valor-obs').innerText = ` Total a pagar`;
				}
				
		        document.getElementById('valor-pagar').innerText = `R$ ${valor.toFixed(2)}`;
		    }

		    // Iniciar o cálculo
		    calculateUsage();

		    // Se "devolvida" não existir, atualizar dinamicamente a cada minuto
		    if (!devolvida) {
		        setInterval(calculateUsage, 60000); // Atualizar a cada 60 segundos
		    }
	</script>
		
</body>

</html>